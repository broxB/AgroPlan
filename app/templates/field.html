{% extends "base.html" %}
{% from 'utils.html' import render_icon %}
{% from "utils.html" import render_accordion with context %}
{% from "_field_fertilization.html" import render_fertilization with context %}
{% from "_field_fertilization.html" import render_fertilization_nutrients with context %}
{# {% from "_field_fertilization.html" import render_total with context %} #}

{% block app_content %}
  <!--field header-->
  {% set db = namespace(field = none) %}
  {% for field in base_field.fields if field.year == current_user.year %}
    {% set db.field = field %}
  {% endfor %}
  <div class="row"
       id="field"
       data-base-id="{{ base_field.id }}"
       data-field-id="{{ db.field.id }}">
    <div class="col">
      <h1>
        {{ "{prefix:02}-{suffix} {name}".format(prefix=base_field.prefix, suffix=base_field.suffix, name=base_field.name) }}
      </h1>
      <h6>{{ db.field.field_type.value }} â€” {{ db.field.area | format_number(".2f", "ha") }}</h6>
    </div>
    <div class="col-4 col-sm-3 d-inline-flex justify-content-end align-items-start">
      <button class="btn btn-link d-print-none"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#modal"
              data-form="field"
              data-modal="edit"
              data-id="{{ base_field.id }}">
        {{ render_icon("pencil-square", extra_classes="color-green") }}
      </button>
      <button class="btn btn-link d-print-none"
              type="button"
              onclick="window.print();">
        {{ render_icon("printer", extra_classes="color-green") }}
      </button>
    </div>
    <!-- Maybe 3 dot menu -->
    {# <div class="collapse collapse-horizontal show" id="fieldMenu">
      <button class="btn d-md-none" type="button" data-bs-toggle="collapse" data-bs-target="#fieldMenu" aria-controls="fieldMenu" aria-expanded="false" aria-label="Toggle field menu">
        <i class="fa-solid fa-ellipsis-vertical fa-lg color-green"></i>
      </button>
      <i class="fa-solid fa-bars"></i>
      </div> #}
  </div>

  <!-- field nav -->
  <nav class="nav nav-pills bg-green rounded flex-column flex-sm-row my-2 d-print-none"
       id="field-nav">
    <button class="nav-link fw-500 text-white flex-sm-fill text-sm-center"
            id="cultivation-tab"
            data-bs-toggle="tab"
            data-bs-target="#cultivation"
            type="button"
            role="tab"
            aria-controls="cultivation"
            aria-selected="true">
      Cultivation
    </button>
    <button class="nav-link fw-500 text-white flex-sm-fill text-sm-center"
            id="soil-tab"
            data-bs-toggle="tab"
            data-bs-target="#soil"
            type="button"
            role="tab"
            aria-controls="soil"
            aria-selected="false">
      Soil
    </button>
    <button class="nav-link fw-500 text-white flex-sm-fill text-sm-center"
            id="info-tab"
            data-bs-toggle="tab"
            data-bs-target="#info"
            type="button"
            role="tab"
            aria-controls="info"
            aria-selected="false">
      Info
    </button>
  </nav>

  <!--cultivation data-->
  <div class="tab-pane fade"
       id="cultivation"
       role="tabpanel"
       aria-labelledby="cultivation-tab">
    {% set count = namespace(c = 0) %}
    {% for cult in db.field.cultivations %}
      {% set db.cultivation = cult %}
      {% set count.c = count.c + 1 %}
      {% call render_accordion(title=db.cultivation.cultivation_type.value, sub_title=db.cultivation.crop.name, target=db.cultivation.cultivation_type.name, data_id=db.cultivation.id, style="accordion-cultivation") %}
        {% for cultivation in field.cultivations if cultivation.cultivation_type == db.cultivation.cultivation_type %}
          <div class="row cultivation">
            <h6 class="fw-bolder text-decoration-underline">Cultivation</h6>
            <div class="col-xxl-6 ms-1">{% include "_field_crop.html" %}</div>
            <div class="col ms-1">{% include "_field_demand.html" %}</div>
          </div>
          <div class="row organic">
            <div class="col-6 my-1">
              <button class="btn btn-success fw-bolder d-print-none"
                      type="button"
                      data-bs-toggle="modal"
                      data-bs-target="#modal"
                      data-form="fertilization"
                      data-modal="new">
                Add fertilization
              </button>
            </div>
            <h6 class="fw-bolder text-decoration-underline">Organic</h6>
            <div class="col-xxl-6 ms-1">{{ render_fertilization(db.cultivation, "organic", db.field) }}</div>
            <div class="col ms-1">{{ render_fertilization_nutrients(cultivation, "organic") }}</div>
          </div>
          <div class="row mineral">
            <h6 class="fw-bolder text-decoration-underline">Mineral</h6>
            <div class="col-xxl-6 ms-1">{{ render_fertilization(db.cultivation, "mineral", db.field) }}</div>
            <div class="col ms-1">{{ render_fertilization_nutrients(cultivation, "mineral") }}</div>
          </div>
        {% endfor %}
      {% endcall %}
    {% endfor %}
    {% if count.c < 3 %}
      <button class="btn btn-success fw-bolder d-print-none"
              type="button"
              data-bs-toggle="modal"
              data-bs-target="#modal"
              data-form="cultivation"
              data-modal="new">
        Add cultivation
      </button>
    {% endif %}
  </div>
  <!--soil data-->
  <div class="tab-pane fade"
       id="soil"
       role="tabpanel"
       aria-labelledby="soil-tab">
    {% call render_accordion(title="Soil Sample", target="soil-sample", style="accordion-soil", collapsed=false) %}
      {% include "_field_soil.html" %}
    {% endcall %}
  </div>
  <!--modifier data-->
  <div class="tab-pane fade"
       id="info"
       role="tabpanel"
       aria-labelledby="info-tab">
    {% call render_accordion(title="Modifiers", target="modifiers", collapsed=false) %}
      {% include "_field_modifiers.html" %}
    {% endcall %}
  </div>

{% endblock app_content %}
